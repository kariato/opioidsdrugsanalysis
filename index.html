<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Visualization of the Opioid Crisis in the USA</title>
    <!-- plugins:css -->
    <link rel="stylesheet" href="assets/vendors/iconfonts/mdi/css/materialdesignicons.min.css">
    <link rel="stylesheet" href="assets/vendors/iconfonts/ionicons/dist/css/ionicons.css">
    <link rel="stylesheet" href="assets/vendors/iconfonts/flag-icon-css/css/flag-icon.min.css">
    <link rel="stylesheet" href="assets/vendors/css/vendor.bundle.base.css">
    <link rel="stylesheet" href="assets/vendors/css/vendor.bundle.addons.css">
    <!-- endinject -->
    <!-- plugin css for this page -->
    <!-- End plugin css for this page -->
    <!-- inject:css -->
    <link rel="stylesheet" href="assets/css/shared/style.css">
    <!-- endinject -->
    <!-- Layout styles -->
    <link rel="stylesheet" href="assets/css/demo_1/style.css">
    <!-- End Layout styles -->
    <link rel="shortcut icon" href="assets/images/favicon.ico" />
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://d3js.org/topojson.v2.min.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <script src="https://unpkg.com/d3-simple-slider"></script>
    <style>
        body {
            align-items: center;
        }

        #tooltip {
            background-color: rgba(0,0,0,0.6);
            width: 200px;
            height: 60px;
            padding: 5px;
            color: white;
            border-radius: 0 10px 0 10px;
            box-shadow: 2px 1px 4px gray;
        }

        #root {
            color: black;
            box-shadow: 4px 8px 4px 8px;
            padding-left: 100px;
        }
    </style>
</head>
<body >
    <div class="container-scroller">
        <!-- partial:partials/_navbar.html -->
        <nav class="navbar default-layout col-lg-12 col-12 p-0 fixed-top d-flex flex-row">
            <div class="text-center navbar-brand-wrapper d-flex align-items-center justify-content-center">
                <a class="navbar-brand brand-logo" href="index.html">
                    <h4>Team #114: Team Big Data</h4>
                </a>
            </div>
            <div class="navbar-menu-wrapper d-flex align-items-center">
                <ul class="navbar-nav">
                    <li class="nav-item font-weight-semibold d-none d-lg-block">
                        <h2>Visualization of the Opioid Crisis in the USA</h2>
                    </li>
                </ul>

            </div>
        </nav>
        <!-- partial -->
        <div class="container-fluid page-body-wrapper">
            <!-- partial:partials/_sidebar.html -->
            <!-- partial -->
            <div class="main-panel">
                <div class="content-wrapper">

                    <div class="row">
                        <div class="col-md-8 grid-margin stretch-card">
                            <div class="card">
                                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                                    <h6 class="m-0 font-weight-bold text-primary">Opioid County Map</h6>
                                </div>
                                <div class="card-body d-flex flex-column">

                                    <!--<div id="dashboard-vmap" class="vector-map"></div>-->
                                    <div id="root" class="vector-map">
                                        <div class="row align-items-end">
                                            <div class="col-sm">
                                                <div>
                                                    <div class="col-sm-2" id="slider-time"></div>



                                                    <!--<div class="col-sm-2">Selected Year:<p id="value-time"></p></div>-->
                                                    <div class="col-sm-2">
                                                        <input type="radio" id="Oxycodone" style="vertical-align: middle; " name="opioid" value="Oxycodone">
                                                        <label for="Oxycodone">Oxycodone</label>
                                                        <input type="radio" id="O2" style="vertical-align: middle" name="opioid" value="O2">
                                                        <label for="O2">Oxydon2</label>
                                                        <input type="radio" id="other" style="vertical-align: middle" name="opioid" value="other">
                                                        <label for="other">Other</label>
                                                    </div class="col-sm-2">
                                                </div>
                                                
                                                
                                            </div>

                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 grid-margin stretch-card">
                            <div class="card">
                                <div class="card-body d-flex flex-column">
                                    <div class="wrapper">
                                        <h4 class="card-title font-weight-bold text-primary mb-0">Location</h4>
                                        <div class="mb-4 font-weight-bold text-primary" id="net-profit-legend">State: Virginia</div>
                                        <div class="mb-4 font-weight-bold text-primary" id="net-profit-legend">County: Fairfax County</div>
                                        <div class="mb-4 font-weight-bold text-primary" id="net-profit-legend">Population: 1,146,000</div>
                                    </div>
                                    The facts<br />
                                    Pills transacted per 100,000 people:
                                    {num_here} <br />
                                    Grams of opioids bought per person:
                                    {num_here}<br />
                                    Etc.<br />
                                    The factors<br />
                                    <div class="mb-4" id="net-profit-legend"><b>Correlate #1:</b> {value for year}</div>
                                    <canvas class="mt-n4" height="90" id="total-revenue"></canvas>
                                    <div class="mb-4" id="net-profit-legend"><b>Correlate #2:</b> {value for year}</div>
                                    <canvas class="mt-n3" height="90" id="total-transaction"></canvas>
                                    <div class="mb-4" id="net-profit-legend"><b>Correlate #3:</b> {value for year}</div>
                                    <canvas class="mt-n4" height="90" id="total-revenue3"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-8">
                            <div class="row">
                                <div class="col-md-6 grid-margin stretch-card">
                                    <div class="card">
                                        <div class="card-body pb-0">
                                            <div class="d-flex justify-content-between">
                                                <h4 class="card-title mb-0">Unemployment</h4>
                                                <p class="font-weight-semibold mb-0">+1.37%</p>
                                            </div>
                                        </div>
                                        <canvas class="mt-n4" height="90" id="total-revenue2"></canvas>
                                    </div>
                                </div>
                                <div class="col-md-6 grid-margin stretch-card">
                                    <div class="card">
                                        <div class="card-body pb-0">
                                            <div class="d-flex justify-content-between">
                                                <h4 class="card-title mb-0">Transaction</h4>
                                                <p class="font-weight-semibold mb-0">-2.87%</p>
                                            </div>
                                            <h3 class="font-weight-medium">147.7K</h3>
                                        </div>
                                        <canvas class="mt-n3" height="90" id="total-transaction2"></canvas>
                                    </div>
                                </div>
                                <div class="col-md-12 grid-margin">
                                    <div class="card">
                                        <div class="card-body">
                                            <h4 class="card-title mb-0">Market Overview</h4>
                                            <div class="d-flex align-items-center justify-content-between w-100">
                                                <p class="mb-0">Lorem ipsum dolor sit amet consectetur adipisicing elit.</p>
                                                <div class="dropdown">
                                                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="dateSorter" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">This Month</button>
                                                    <div class="dropdown-menu" aria-labelledby="dateSorter">
                                                        <div class="dropdown-item" id="market-overview_1">Daily</div>
                                                        <div class="dropdown-item" id="market-overview_2">Weekly</div>
                                                        <div class="dropdown-item" id="market-overview_3">Monthly</div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="d-flex align-items-end">
                                                <h3 class="mb-0 font-weight-semibold">$36,2531.00</h3>
                                                <p class="mb-0 font-weight-medium mr-2 ml-2 mb-1">USD</p>
                                                <p class="mb-0 text-success font-weight-semibold mb-1">(+1.37%)</p>
                                            </div>
                                            <canvas class="mt-4" height="100" id="market-overview-chart"></canvas>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-12 grid-margin">
                                    <div class="card">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between">
                                                <h4 class="card-title mb-0">Invoice</h4>
                                                <a href="#"><small>Show All</small></a>
                                            </div>
                                            <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit. Est quod cupiditate esse fuga</p>
                                            <div class="table-responsive">
                                                <table class="table table-striped table-hover">
                                                    <thead>
                                                        <tr>
                                                            <th>Invoice ID</th>
                                                            <th>Customer</th>
                                                            <th>Status</th>
                                                            <th>Due Date</th>
                                                            <th>Amount</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr>
                                                            <td>INV-87239</td>
                                                            <td>Viola Ford</td>
                                                            <td>Paid</td>
                                                            <td>20 Jan 2019</td>
                                                            <td>$755</td>
                                                        </tr>
                                                        <tr>
                                                            <td>INV-87239</td>
                                                            <td>Dylan Waters</td>
                                                            <td>Unpaid</td>
                                                            <td>23 Feb 2019</td>
                                                            <td>$800</td>
                                                        </tr>
                                                        <tr>
                                                            <td>INV-87239</td>
                                                            <td>Louis Poole</td>
                                                            <td>Unpaid</td>
                                                            <td>25 Mar 2019</td>
                                                            <td>$463</td>
                                                        </tr>
                                                        <tr>
                                                            <td>INV-87239</td>
                                                            <td>Vera Howell</td>
                                                            <td>Paid</td>
                                                            <td>27 Mar 2019</td>
                                                            <td>$235</td>
                                                        </tr>
                                                        <tr>
                                                            <td>INV-87239</td>
                                                            <td>Allie Goodman</td>
                                                            <td>Unpaid</td>
                                                            <td>1 Apr 2019</td>
                                                            <td>$657</td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 grid-margin stretch-card">
                                    <div class="card">
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="d-flex align-items-center pb-2">
                                                        <div class="dot-indicator bg-danger mr-2"></div>
                                                        <p class="mb-0">Total Sales</p>
                                                    </div>
                                                    <h4 class="font-weight-semibold">$7,590</h4>
                                                    <div class="progress progress-md">
                                                        <div class="progress-bar bg-danger" role="progressbar" style="width: 78%" aria-valuenow="78" aria-valuemin="0" aria-valuemax="78"></div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6 mt-4 mt-md-0">
                                                    <div class="d-flex align-items-center pb-2">
                                                        <div class="dot-indicator bg-success mr-2"></div>
                                                        <p class="mb-0">Active Users</p>
                                                    </div>
                                                    <h4 class="font-weight-semibold">$5,460</h4>
                                                    <div class="progress progress-md">
                                                        <div class="progress-bar bg-success" role="progressbar" style="width: 45%" aria-valuenow="45" aria-valuemin="0" aria-valuemax="45"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 grid-margin stretch-card average-price-card">
                                    <div class="card text-white">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between pb-2 align-items-center">
                                                <h2 class="font-weight-semibold mb-0">4,624</h2>
                                                <div class="icon-holder">
                                                    <i class="mdi mdi-briefcase-outline"></i>
                                                </div>
                                            </div>
                                            <div class="d-flex justify-content-between">
                                                <h5 class="font-weight-semibold mb-0">Average Price</h5>
                                                <p class="text-white mb-0">Since last month</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="row">
                                <div class="col-md-12 grid-margin">
                                    <div class="card">
                                        <div class="card-body">
                                            <h1 class="card-title mb-4">
                                                Correlation of Opioid-related Mortality and
                                                Top Three Factors 2006-2012
                                            </h1>
                                            <div class="row">
                                                <div class="col-5 col-md-5">
                                                    <div class="wrapper border-bottom mb-2 pb-2">
                                                        <h4 class="font-weight-semibold mb-0">Unemployment</h4>
                                                        <div class="d-flex align-items-center">
                                                            <p class="mb-0">5%</p>
                                                            <div class="dot-indicator bg-secondary ml-auto"></div>
                                                        </div>
                                                    </div>
                                                    <div class="wrapper">
                                                        <h4 class="font-weight-semibold mb-0">Opioid Sales</h4>
                                                        <div class="d-flex align-items-center">
                                                            <p class="mb-0">1.5 pills per person</p>
                                                            <div class="dot-indicator bg-primary ml-auto"></div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-5 col-md-7 d-flex pl-4">
                                                    <div class="ml-auto">
                                                        <canvas height="100" id="realtime-statistics"></canvas>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="row mt-5">
                                                <div class="col-6">
                                                    <div class="d-flex align-items-center mb-2">
                                                        <div class="icon-holder bg-primary text-white py-1 px-3 rounded mr-2">
                                                            <i class="icon ion-logo-buffer icon-sm"></i>
                                                        </div>
                                                        <h2 class="font-weight-semibold mb-0">3,605</h2>
                                                    </div>
                                                    <p>Since last week</p>
                                                    <p><span class="font-weight-medium">0.51%</span> (30 days)</p>
                                                </div>
                                                <div class="col-6">
                                                    <div class="mt-n3 ml-auto" id="dashboard-guage-chart"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-12 grid-margin">
                                    <div class="card">
                                        <div class="card-body">
                                            <h4 class="card-title mb-4">World sellings</h4>

                                            <div class="wrapper">
                                                <div class="d-flex w-100 pt-2 mt-4">
                                                    <p class="mb-0 font-weight-semibold">California</p>
                                                    <div class="wrapper ml-auto d-flex align-items-center">
                                                        <p class="font-weight-semibold mb-0">26,437</p>
                                                        <p class="ml-1 mb-0">26%</p>
                                                    </div>
                                                </div>
                                                <div class="d-flex w-100 pt-2">
                                                    <p class="mb-0 font-weight-semibold">Washington</p>
                                                    <div class="wrapper ml-auto d-flex align-items-center">
                                                        <p class="font-weight-semibold mb-0">3252</p>
                                                        <p class="ml-1 mb-0">64%</p>
                                                    </div>
                                                </div>
                                                <div class="d-flex w-100 pt-2">
                                                    <p class="mb-0 font-weight-semibold">Michigan</p>
                                                    <div class="wrapper ml-auto d-flex align-items-center">
                                                        <p class="font-weight-semibold mb-0">4,987</p>
                                                        <p class="ml-1 mb-0">30%</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-12 grid-margin">
                                    <div class="card">
                                        <div class="card-body">
                                            <h4 class="card-title mb-0">Top Performer</h4>
                                            <div class="d-flex mt-3 py-2 border-bottom">
                                                <img class="img-sm rounded-circle" src="assets/images/faces/face3.jpg" alt="profile image">
                                                <div class="wrapper ml-2">
                                                    <p class="mb-n1 font-weight-semibold">Ray Douglas</p>
                                                    <small>162543</small>
                                                </div>
                                                <small class="text-muted ml-auto">1 Hours ago</small>
                                            </div>
                                            <div class="d-flex py-2 border-bottom">
                                                <span class="img-sm rounded-circle bg-warning text-white text-avatar">OH</span>
                                                <div class="wrapper ml-2">
                                                    <p class="mb-n1 font-weight-semibold">Ora Hill</p>
                                                    <small>162543</small>
                                                </div>
                                                <small class="text-muted ml-auto">4 Hours ago</small>
                                            </div>
                                            <div class="d-flex py-2 border-bottom">
                                                <img class="img-sm rounded-circle" src="assets/images/faces/face4.jpg" alt="profile image">
                                                <div class="wrapper ml-2">
                                                    <p class="mb-n1 font-weight-semibold">Brian Dean</p>
                                                    <small>162543</small>
                                                </div>
                                                <small class="text-muted ml-auto">4 Hours ago</small>
                                            </div>
                                            <div class="d-flex pt-2">
                                                <span class="img-sm rounded-circle bg-success text-white text-avatar">OB</span>
                                                <div class="wrapper ml-2">
                                                    <p class="mb-n1 font-weight-semibold">Olive Bridges</p>
                                                    <small>162543</small>
                                                </div>
                                                <small class="text-muted ml-auto">7 Hours ago</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 grid-margin stretch-card">
                            <div class="card">
                                <div class="card-body">
                                    <h4 class="card-title mb-0">Recent Events</h4>
                                    <div class="d-flex py-2 border-bottom">
                                        <div class="wrapper">
                                            <small class="text-muted">Mar 14, 2019</small>
                                            <p class="font-weight-semibold text-gray mb-0">Change in Directors</p>
                                        </div>
                                        <small class="text-muted ml-auto">Edit event</small>
                                    </div>
                                    <div class="d-flex py-2 border-bottom">
                                        <div class="wrapper">
                                            <small class="text-muted">Mar 14, 2019</small>
                                            <p class="font-weight-semibold text-gray mb-0">Other Events</p>
                                        </div>
                                        <small class="text-muted ml-auto">Edit event</small>
                                    </div>
                                    <div class="d-flex py-2 border-bottom">
                                        <div class="wrapper">
                                            <small class="text-muted">Mar 14, 2019</small>
                                            <p class="font-weight-semibold text-gray mb-0">Quarterly Report</p>
                                        </div>
                                        <small class="text-muted ml-auto">Edit event</small>
                                    </div>
                                    <div class="d-flex pt-2">
                                        <div class="wrapper">
                                            <small class="text-muted">Mar 14, 2019</small>
                                            <p class="font-weight-semibold text-gray mb-0">Change in Directors</p>
                                        </div>
                                        <small class="text-muted ml-auto">Edit event</small>
                                    </div>
                                    <a class="d-block mt-5" href="#">Show all</a>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 grid-margin stretch-card">
                            <div class="card">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between pb-3">
                                        <h4 class="card-title mb-0">Activities</h4>
                                        <p class="mb-0 text-muted">20 finished, 5 remaining</p>
                                    </div>
                                    <ul class="timeline">
                                        <li class="timeline-item">
                                            <p class="timeline-content"><a href="#">Ben Tossell</a> assign you a task</p>
                                            <p class="event-time">Just now</p>
                                        </li>
                                        <li class="timeline-item">
                                            <p class="timeline-content"><a href="#">Ben Tossell</a> assign you a task</p>
                                            <p class="event-time">Just now</p>
                                        </li>
                                        <li class="timeline-item">
                                            <p class="timeline-content"><a href="#">Ben Tossell</a> assign you a task</p>
                                            <p class="event-time">Just now</p>
                                        </li>
                                        <li class="timeline-item">
                                            <p class="timeline-content"><a href="#">Ben Tossell</a> assign you a task</p>
                                            <p class="event-time">Just now</p>
                                        </li>
                                        <li class="timeline-item">
                                            <p class="timeline-content"><a href="#">Ben Tossell</a> assign you a task</p>
                                            <p class="event-time">Just now</p>
                                        </li>
                                    </ul>
                                    <a class="d-block mt-3" href="#">Show all</a>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 grid-margin stretch-card">
                            <div class="card">
                                <div class="card-body">
                                    <h4 class="card-title mb-0">People Also Watch</h4>
                                    <div class="table-responsive">
                                        <table class="table table-stretched">
                                            <thead>
                                                <tr>
                                                    <th>Symbol</th>
                                                    <th>Last Price</th>
                                                    <th>Change</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td>
                                                        <p class="mb-1 text-dark font-weight-medium">NFLX</p><small class="font-weight-medium">Netflix, Inc.</small>
                                                    </td>
                                                    <td class="font-weight-medium">$250.00</td>
                                                    <td class="text-success font-weight-medium">+12.64</td>
                                                </tr>
                                                <tr>
                                                    <td>
                                                        <p class="mb-1 text-dark font-weight-medium">TSLA</p><small class="font-weight-medium">Tesla, Inc.</small>
                                                    </td>
                                                    <td class="font-weight-medium">$458.00</td>
                                                    <td class="text-danger font-weight-medium">-14.53</td>
                                                </tr>
                                                <tr>
                                                    <td>
                                                        <p class="mb-1 text-dark font-weight-medium">GOOG</p><small class="font-weight-medium">Alphabet, Inc.</small>
                                                    </td>
                                                    <td class="font-weight-medium">$250.00</td>
                                                    <td class="text-danger font-weight-medium">+12.64</td>
                                                </tr>
                                                <tr>
                                                    <td>
                                                        <p class="mb-1 text-dark font-weight-medium">AMZN</p><small class="font-weight-medium">Amazon.com, Inc.</small>
                                                    </td>
                                                    <td class="font-weight-medium">$546.00</td>
                                                    <td class="text-success font-weight-medium">+24.34</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <a class="d-block mt-3" href="#">Show all</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- content-wrapper ends -->
                <!-- partial:partials/_footer.html -->
                <footer class="footer">
                    <div class="container-fluid clearfix">
                        <span class="text-muted d-block text-center text-sm-left d-sm-inline-block">CSE6242 Project</span>
                        <span class="float-none float-sm-right d-block mt-1 mt-sm-0 text-center"> Team #114</span>
                    </div>
                </footer>
                <!-- partial -->
            </div>
            <!-- main-panel ends -->
        </div>
        <!-- page-body-wrapper ends -->
    </div>
    <!-- container-scroller -->
    <!-- plugins:js -->
    <script src="assets/vendors/js/vendor.bundle.base.js"></script>
    <script src="assets/vendors/js/vendor.bundle.addons.js"></script>

    <script src="assets/js/shared/off-canvas.js"></script>
    <script src="assets/js/shared/misc.js"></script>

    <script src="assets/js/shared/jquery.cookie.js" type="text/javascript"></script>
    <!--<script src="assets/js/D3/dashboard.js" type="text/javascript" ></script>-->
    <script type="text/javascript">

        var mouseDown = 0;

        
        const root = document.getElementById("root");
        const tooltip = document.createElement("div");
        tooltip.setAttribute("id", "tooltip");
        tooltip.setAttribute("data-year", 0);
        tooltip.setAttribute("style", "visibility: hidden");
        
        root.appendChild(tooltip);
        //alert('hello');

       

        const w = 1000;
        const h = 700;
        const padding = 100;

        const svg = d3.select("#root")
            .append("svg")
            .attr("width", w)
            .attr("height", h);

        var selectedYear = "2006";
        const MAX_QUANTITY_OXYCODENE = 887862;
        var oxycodeneRange = [0, 200, 500, 1000, 2000, 30000, 5000, 10000, 20000, 50000, 70000, 1000000, 2000000, 300000, 4000000, 500000, 600000, 700000, MAX_QUANTITY_OXYCODENE]

        const counties = d3.json("data\\counties-albers-10m.json")
        const realPromise = d3.csv("data\\master_rollup.csv")
            .then(function (data) {
                let fipsData = {};
                let result = {};
               sameYearData = {}
               for (var i = 0; i < data.length; i++) {
                    //console.log(data[i]);
                   //console.log(data[i]);
                   padded_key = data[i].fips_code.padStart(5, 0);
                   if (!([data[i].year] in result))
                   {
                       result[data[i].year] = {}
                   }
                   result[data[i].year][padded_key] = data[i];
                  
                }
                return result;
            });

            var dataTime = d3.range(0, 7).map(function (d) {
                return new Date(2006 + d, 7, 3);
            });

            var sliderTime = d3
                .sliderBottom()
                .min(d3.min(dataTime))
                .max(d3.max(dataTime))
                .step(1000 * 60 * 60 * 24 * 365)
                .width(300)
                .tickFormat(d3.timeFormat('%Y'))
                .tickValues(dataTime)
                .default(new Date(2006, 01, 01))
                .on('onchange', val => {

                    if ((selectedYear != d3.timeFormat('%Y')(val))) {
                        selectedYear = d3.timeFormat('%Y')(val);

                        //alert(selectedYear + "<<changed<<" + val);
                        drawMap(counties, realPromise, selectedYear);
                    }

                });

        var gTime = d3
            .select('div#slider-time')
            .append('svg')
            .attr('width', 500)
            .attr('height', 100)
            .append('g')
            .attr('transform', 'translate(30,30)');
          

            gTime.call(sliderTime);

        //d3.select('p#value-time').text(d3.timeFormat('%Y')(sliderTime.value()));
        //var i = 0;
        

        function drawMap(geoData, allData, year) {

           

            Promise.all([geoData, allData]).then(values => {
                let topology = values[0];
                var yearAsInt = parseInt(year);
                let countyData = values[1][yearAsInt];
             
                let svgScale = topology.transform.scale;
                let arcs = topology.arcs;

                svg.append("text")
                    .attr("id", "title")
                    .attr("x", w / 2)
                    .attr("y", padding / 3)
                    .attr("font-size", "2em")
                    .attr("text-anchor", "middle")
                    .text("Choropleth Map")

                svg.append("text")
                    .attr("id", "description")
                    .attr("x", w / 2)
                    .attr("y", padding * 2 / 3)
                    .attr("text-anchor", "middle")
                    .text("Quantity of Oxycodone per 100'000 people")

                let legend_w = 240;
                let legend_h = 30;
                let hsl_min = 0;
                let hsl_max = 149
                let pct_min = 0;
                let pct_max = 101;
                let n_step = 11;
                //let COLORS = [];
                //for (let i = 0; i < n_step; i++) {
                //    COLORS.push({
                //        color: `hsl(${(hsl_max - hsl_min) / n_step * i}, 86%, 74%)`,
                //        inRange: (x) =>
                //            i * (pct_max - pct_min) / n_step <= x &&
                //            x < (i + 1) * (pct_max - pct_min) / n_step,
                //        text: `${i * (pct_max - pct_min) / n_step}%`
                //    });
                //}
                //let legend = svg.append("g")
                //    .attr("id", "legend")
                //    .attr("transform", `translate(${500},${100})`);
                //legend.selectAll("rect")
                //    .exit()
                //    .data(COLORS)
                //    .enter()
                //    .append("rect")
                //    .attr("x", (d, i) => i * legend_w / n_step)
                //    .attr("y", 0)
                //    .attr("width", legend_w / n_step)
                //    .attr("height", legend_h / 3)
                //    .attr("fill", (d, i) => d.color)

                //legend.selectAll("line")
                //    .exit()
                //    .data(COLORS)
                //    .enter()
                //    .append("line")
                //    .attr("x1", (d, i) => i * legend_w / n_step)
                //    .attr("y1", 0)
                //    .attr("x2", (d, i) => i * legend_w / n_step)
                //    .attr("y2", legend_h * 1.5 / 3)
                //    .attr("stroke", "black")
                //    .attr("stroke-width", "1px")

                //legend.selectAll("text")
                //    .exit()
                //    .data(COLORS)
                //    .enter()
                //    .append("text")
                //    .attr("x", 100)
                //    .attr("y", 100)
                //    .attr("x", (d, i) => i * legend_w / n_step)
                //    .attr("y", legend_h * 2.5 / 3)
                //    .attr("text-anchor", "middle")
                //    .attr("justify-content", "space-around")
                //    .attr("font-size", "0.69em")
                //    .text(d => d.text)


                const arcArrayToPath = (A) => {
                    let d = ["M"];
                    let i = A[0];
                    if (i < 0) {
                        let a = arcs[~i];
                        let x = a[0][0];
                        let y = a[0][1];
                        for (let k = 1; k < a.length; k++) {
                            x += a[k][0];
                            y += a[k][1];
                        }
                        d.push(x + "," + y);
                    } else {
                        d.push(arcs[i][0][0] + "," + arcs[i][0][1]);
                    }
                    d.push("m");

                    for (let i of A) {
                        if (i < 0) {
                            let a = arcs[~i];
                            for (let k = a.length - 1; k > 0; k--) {
                                d.push(-a[k][0] + "," + -a[k][1]);
                            }
                        } else {
                            d.push(...arcs[i].slice(1).map(p => p.join(",")));
                        }
                    }
                    d.push("z")
                    return d.join(" ");
                };

                const polygonToPath = (P) => {
                    let d = [];
                    for (let A of P) {
                        d.push(arcArrayToPath(A));
                    }
                    return d.join(" ");
                };
                let countyGeometries = topology.objects.counties.geometries;
                //let N_COUNTIES = Object.keys(countyData).length;
                let N_COUNTIES = countyGeometries.length;
                for (let i = 0; i < N_COUNTIES; i++) {
                    let geom = countyGeometries[i];
                    let currentCountData = countyData[geom.id];
                    //let data = countyData[i];

                    let g = svg.append("g")
                        .classed("county", true)
                        .attr("fill", () => { // EHHH

                            var colorScale = d3.scaleQuantile()
                                .domain(oxycodeneRange)

                                .range(['#ffffcc', '#ffeda0', '#fed976', '#feb24c', '#fd8d3c', '#fc4e2a', '#e31a1c', '#bd0026', '#800026']);
                            //.range([ '#feb24c',  '#fc4e2a', '#bd0026', '#800026']);

                            if (currentCountData == null)
                                return "hsl(0,0%,50%)";
                            else
                                return colorScale(currentCountData.QUANTITY_OXYCODONE);
                        })
                        .attr("transform", `translate(0,${padding}) scale(${svgScale.join(", ")})`)
                        .attr("data-fips", currentCountData == null ? geom.id : currentCountData.county_fips)
                        //.attr("state", data.state)
                        .attr("area-name", currentCountData == null ? geom.properties.name : currentCountData.area_name)
                        .attr("data-oxycodone", currentCountData == null ? "No data" : currentCountData.QUANTITY_OXYCODONE)
                        .on("mouseover", function (d, i, node)  {
                            tooltip.style.visibility = "visible";

                            tooltip.setAttribute("quantity-oxycodne", currentCountData == null ? "No data" : currentCountData.QUANTITY_OXYCODONE);  // Ugh?
                            let bbox = node[0].getBBox();
                            let tx = (bbox.x + bbox.width / 2) * svgScale[0];
                            let ty = (bbox.y + bbox.height / 2) * svgScale[1];
                            tooltip.style.transform = `translate(${tx + 15}px, ${ty + padding}px)`;

                            let lines = [
                                `${currentCountData == null ? geom.properties.name : currentCountData.area_name}`,
                                `${currentCountData == null ? "No data" : currentCountData.QUANTITY_OXYCODONE}`
                            ];
                            tooltip.innerHTML = lines.join("<br>");
                        })
                        .on("mouseout", (d) => {
                            tooltip.style.visibility = "invisible";
                        });

                    if (geom.type == "Polygon") {
                        g.append("path").attr("d", polygonToPath(geom.arcs));
                    } else if (geom.type === "MultiPolygon") {
                        for (let poly of geom.arcs) {
                            g.append("path").attr("d", polygonToPath(poly));
                        }
                    }
                }


                let statesGeometries = topology.objects.states.geometries;
                let N_STATES = statesGeometries.length;
                for (let i = 0; i < N_STATES; i++) {
                    let g = svg.append("g")
                        .classed("state", true)
                        .attr("transform", `translate(0,${padding}) scale(${svgScale.join(", ")})`);

                    for (let poly of statesGeometries[i].arcs) {
                        g.append("path")
                            .attr("fill", "none")
                            .attr("stroke", "white")
                            .attr("stroke-width", "5em")
                            .attr("d", polygonToPath(poly));
                    }
                }

            });

        }

        drawMap(counties, realPromise, selectedYear);



    </script>
</body>
</html>